#include "histogram.h"

#include "registry.h"
#include "visitor.h"

#include <library/cpp/monlib/dynamic_counters/counters.h>
#include <library/cpp/testing/unittest/registar.h>

namespace NCloud::NFileStore::NMetrics {

namespace {

////////////////////////////////////////////////////////////////////////////////

struct TEnv
    : public NUnitTest::TBaseFixture
{
    TStringStream Data;
    NMonitoring::TDynamicCountersPtr Counters;

    IRegistryVisitorPtr Visitor;
    IMainMetricsRegistryPtr Registry;

    TEnv()
        : Counters(MakeIntrusive<NMonitoring::TDynamicCounters>())
        , Visitor(CreateRegistryVisitor(Data))
    {
        SetupRegistry();
    }

    void SetUp(NUnitTest::TTestContext& /*context*/) override
    {}

    void TearDown(NUnitTest::TTestContext& /*context*/) override
    {}

    void SetupRegistry(TLabels commonLabels = {})
    {
        Registry = CreateMetricsRegistry(std::move(commonLabels), Counters);
    }
};

}   // namespace

////////////////////////////////////////////////////////////////////////////////

Y_UNIT_TEST_SUITE(THistogramTest)
{
    Y_UNIT_TEST(ShouldGetHistRangeName)
    {
        UNIT_ASSERT_VALUES_EQUAL(
            14,
            static_cast<ui32>(NImpl::TRangeTraits<EHistUnit::HU_COUNT>::HIST_MAX));

        UNIT_ASSERT_VALUES_EQUAL("1", NImpl::GetHistRangeName<EHistUnit::HU_COUNT>(0));
        UNIT_ASSERT_VALUES_EQUAL("2", NImpl::GetHistRangeName<EHistUnit::HU_COUNT>(1));
        UNIT_ASSERT_VALUES_EQUAL("5", NImpl::GetHistRangeName<EHistUnit::HU_COUNT>(2));
        UNIT_ASSERT_VALUES_EQUAL("10", NImpl::GetHistRangeName<EHistUnit::HU_COUNT>(3));
        UNIT_ASSERT_VALUES_EQUAL("20", NImpl::GetHistRangeName<EHistUnit::HU_COUNT>(4));
        UNIT_ASSERT_VALUES_EQUAL("50", NImpl::GetHistRangeName<EHistUnit::HU_COUNT>(5));
        UNIT_ASSERT_VALUES_EQUAL("100", NImpl::GetHistRangeName<EHistUnit::HU_COUNT>(6));
        UNIT_ASSERT_VALUES_EQUAL("200", NImpl::GetHistRangeName<EHistUnit::HU_COUNT>(7));
        UNIT_ASSERT_VALUES_EQUAL("500", NImpl::GetHistRangeName<EHistUnit::HU_COUNT>(8));
        UNIT_ASSERT_VALUES_EQUAL("1000", NImpl::GetHistRangeName<EHistUnit::HU_COUNT>(9));
        UNIT_ASSERT_VALUES_EQUAL("2000", NImpl::GetHistRangeName<EHistUnit::HU_COUNT>(10));
        UNIT_ASSERT_VALUES_EQUAL("5000", NImpl::GetHistRangeName<EHistUnit::HU_COUNT>(11));
        UNIT_ASSERT_VALUES_EQUAL("10000", NImpl::GetHistRangeName<EHistUnit::HU_COUNT>(12));
        UNIT_ASSERT_VALUES_EQUAL("35000", NImpl::GetHistRangeName<EHistUnit::HU_COUNT>(13));
        UNIT_ASSERT_VALUES_EQUAL(">35000", NImpl::GetHistRangeName<EHistUnit::HU_COUNT>(14));
    }

    Y_UNIT_TEST(ShouldGetHistRangeValue)
    {
        UNIT_ASSERT_VALUES_EQUAL(
            14,
            static_cast<ui32>(NImpl::TRangeTraits<EHistUnit::HU_COUNT>::HIST_MAX));

        UNIT_ASSERT_VALUES_EQUAL(1, NImpl::GetHistRangeValue<EHistUnit::HU_COUNT>(0));
        UNIT_ASSERT_VALUES_EQUAL(2, NImpl::GetHistRangeValue<EHistUnit::HU_COUNT>(1));
        UNIT_ASSERT_VALUES_EQUAL(5, NImpl::GetHistRangeValue<EHistUnit::HU_COUNT>(2));
        UNIT_ASSERT_VALUES_EQUAL(10, NImpl::GetHistRangeValue<EHistUnit::HU_COUNT>(3));
        UNIT_ASSERT_VALUES_EQUAL(20, NImpl::GetHistRangeValue<EHistUnit::HU_COUNT>(4));
        UNIT_ASSERT_VALUES_EQUAL(50, NImpl::GetHistRangeValue<EHistUnit::HU_COUNT>(5));
        UNIT_ASSERT_VALUES_EQUAL(100, NImpl::GetHistRangeValue<EHistUnit::HU_COUNT>(6));
        UNIT_ASSERT_VALUES_EQUAL(200, NImpl::GetHistRangeValue<EHistUnit::HU_COUNT>(7));
        UNIT_ASSERT_VALUES_EQUAL(500, NImpl::GetHistRangeValue<EHistUnit::HU_COUNT>(8));
        UNIT_ASSERT_VALUES_EQUAL(1'000, NImpl::GetHistRangeValue<EHistUnit::HU_COUNT>(9));
        UNIT_ASSERT_VALUES_EQUAL(2'000, NImpl::GetHistRangeValue<EHistUnit::HU_COUNT>(10));
        UNIT_ASSERT_VALUES_EQUAL(5'000, NImpl::GetHistRangeValue<EHistUnit::HU_COUNT>(11));
        UNIT_ASSERT_VALUES_EQUAL(10'000, NImpl::GetHistRangeValue<EHistUnit::HU_COUNT>(12));
        UNIT_ASSERT_VALUES_EQUAL(35'000, NImpl::GetHistRangeValue<EHistUnit::HU_COUNT>(13));
        UNIT_ASSERT_VALUES_EQUAL(Max<i64>(), NImpl::GetHistRangeValue<EHistUnit::HU_COUNT>(14));
    }

    Y_UNIT_TEST(ShouldGetHistRange)
    {
        UNIT_ASSERT_VALUES_EQUAL(
            static_cast<ui32>(NImpl::TRangeTraits<EHistUnit::HU_COUNT>::HIST_1),
            static_cast<ui32>(NImpl::GetHistRange<EHistUnit::HU_COUNT>(-1)));
        UNIT_ASSERT_VALUES_EQUAL(
            static_cast<ui32>(NImpl::TRangeTraits<EHistUnit::HU_COUNT>::HIST_1),
            static_cast<ui32>(NImpl::GetHistRange<EHistUnit::HU_COUNT>(0)));
        UNIT_ASSERT_VALUES_EQUAL(
            static_cast<ui32>(NImpl::TRangeTraits<EHistUnit::HU_COUNT>::HIST_1),
            static_cast<ui32>(NImpl::GetHistRange<EHistUnit::HU_COUNT>(1)));

        UNIT_ASSERT_VALUES_EQUAL(
            static_cast<ui32>(NImpl::TRangeTraits<EHistUnit::HU_COUNT>::HIST_2),
            static_cast<ui32>(NImpl::GetHistRange<EHistUnit::HU_COUNT>(2)));
        UNIT_ASSERT_VALUES_EQUAL(
            static_cast<ui32>(NImpl::TRangeTraits<EHistUnit::HU_COUNT>::HIST_5),
            static_cast<ui32>(NImpl::GetHistRange<EHistUnit::HU_COUNT>(3)));

        for (ui32 i = NImpl::TRangeTraits<EHistUnit::HU_COUNT>::HIST_5;
             i < NImpl::TRangeTraits<EHistUnit::HU_COUNT>::HIST_MAX;
             ++i)
        {
            const ui32 value = NImpl::GetHistRangeValue<EHistUnit::HU_COUNT>(i);
            UNIT_ASSERT_VALUES_EQUAL(
                i,
                static_cast<ui32>(NImpl::GetHistRange<EHistUnit::HU_COUNT>(value - 1)));
            UNIT_ASSERT_VALUES_EQUAL(
                i,
                static_cast<ui32>(NImpl::GetHistRange<EHistUnit::HU_COUNT>(value)));
            UNIT_ASSERT_VALUES_EQUAL(
                i + 1,
                static_cast<ui32>(NImpl::GetHistRange<EHistUnit::HU_COUNT>(value + 1)));
        }

        UNIT_ASSERT_VALUES_EQUAL(
            static_cast<ui32>(NImpl::TRangeTraits<EHistUnit::HU_COUNT>::HIST_MAX),
            static_cast<ui32>(NImpl::GetHistRange<EHistUnit::HU_COUNT>(Max<i64>() - 1)));
        UNIT_ASSERT_VALUES_EQUAL(
            static_cast<ui32>(NImpl::TRangeTraits<EHistUnit::HU_COUNT>::HIST_MAX),
            static_cast<ui32>(NImpl::GetHistRange<EHistUnit::HU_COUNT>(Max<i64>())));
    }

    Y_UNIT_TEST(ShouldGetUnitValueDuration)
    {
        TDuration duration = TDuration::MicroSeconds(123'456'789);

        UNIT_ASSERT_VALUES_EQUAL(
            123'456'789,
            NImpl::GetUnitValue<EHistUnit::HU_TIME_MICROSECONDS>(duration));
        UNIT_ASSERT_VALUES_EQUAL(
            123'456,
            NImpl::GetUnitValue<EHistUnit::HU_TIME_MILLISECONDS>(duration));
        UNIT_ASSERT_VALUES_EQUAL(
            123,
            NImpl::GetUnitValue<EHistUnit::HU_TIME_SECONDS>(duration));
    }

    Y_UNIT_TEST(ShouldGetUnitValue)
    {
        {
            ui64 count = 123'456'789;
            UNIT_ASSERT_VALUES_EQUAL(
                count,
                NImpl::GetUnitValue<EHistUnit::HU_COUNT>(count));
        }

        {
            ui64 duration = 123'456'789;
            UNIT_ASSERT_VALUES_EQUAL(
                duration,
                NImpl::GetUnitValue<EHistUnit::HU_TIME_MICROSECONDS>(duration));
            UNIT_ASSERT_VALUES_EQUAL(
                123'456,
                NImpl::GetUnitValue<EHistUnit::HU_TIME_MILLISECONDS>(duration));
            UNIT_ASSERT_VALUES_EQUAL(
                123,
                NImpl::GetUnitValue<EHistUnit::HU_TIME_SECONDS>(duration));
        }

        {
            ui64 size = 67'108'864;
            UNIT_ASSERT_VALUES_EQUAL(
                size,
                NImpl::GetUnitValue<EHistUnit::HU_SIZE_BYTES>(size));
            UNIT_ASSERT_VALUES_EQUAL(
                65'536,
                NImpl::GetUnitValue<EHistUnit::HU_SIZE_KIBYTES>(size));
            UNIT_ASSERT_VALUES_EQUAL(
                64,
                NImpl::GetUnitValue<EHistUnit::HU_SIZE_MIBYTES>(size));
        }
    }

    Y_UNIT_TEST(ShouldGetUnitSuffix)
    {
        UNIT_ASSERT_VALUES_EQUAL("", NImpl::GetUnitSuffix<EHistUnit::HU_COUNT>());
        UNIT_ASSERT_VALUES_EQUAL("us", NImpl::GetUnitSuffix<EHistUnit::HU_TIME_MICROSECONDS>());
        UNIT_ASSERT_VALUES_EQUAL("ms", NImpl::GetUnitSuffix<EHistUnit::HU_TIME_MILLISECONDS>());
        UNIT_ASSERT_VALUES_EQUAL("s", NImpl::GetUnitSuffix<EHistUnit::HU_TIME_SECONDS>());
        UNIT_ASSERT_VALUES_EQUAL("B", NImpl::GetUnitSuffix<EHistUnit::HU_SIZE_BYTES>());
        UNIT_ASSERT_VALUES_EQUAL("KiB", NImpl::GetUnitSuffix<EHistUnit::HU_SIZE_KIBYTES>());
        UNIT_ASSERT_VALUES_EQUAL("MiB", NImpl::GetUnitSuffix<EHistUnit::HU_SIZE_MIBYTES>());
    }

    Y_UNIT_TEST_F(ShouldGetCorrectValues, TEnv)
    {
        THistogram<EHistUnit::HU_COUNT> hist;
        hist.Register(Registry, {CreateLabel("histogram", "Count")});

        Registry->Visit(TInstant::Zero(), *Visitor);
        UNIT_ASSERT_VALUES_EQUAL(
            "metrics:["
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'20'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'5000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'1000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'100'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'200'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'35000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'2000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'5'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'2'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'1'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'500'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'10'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'>35000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'10000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'50'},"
                    "],"
                    "value:'0',"
                "},"
            "]",
            Data.Str());
        Data.Clear();

        hist.Record(123, 2);

        Registry->Visit(TInstant::Zero(), *Visitor);
        UNIT_ASSERT_VALUES_EQUAL(
            "metrics:["
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'20'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'5000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'1000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'100'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'200'},"
                    "],"
                    "value:'2',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'35000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'2000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'5'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'2'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'1'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'500'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'10'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'>35000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'10000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'50'},"
                    "],"
                    "value:'0',"
                "},"
            "]",
            Data.Str());
        Data.Clear();
    }

    Y_UNIT_TEST_F(ShouldCorrectlyUnregister, TEnv)
    {
        THistogram<EHistUnit::HU_COUNT> hist;
        const auto key =
            hist.Register(Registry, {CreateLabel("histogram", "Count")});

        Registry->Visit(TInstant::Zero(), *Visitor);
        UNIT_ASSERT_VALUES_EQUAL(
            "metrics:["
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'20'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'5000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'1000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'100'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'200'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'35000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'2000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'5'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'2'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'1'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'500'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'10'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'>35000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'10000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'50'},"
                    "],"
                    "value:'0',"
                "},"
            "]",
            Data.Str());
        Data.Clear();

        hist.Unregister(TMetricKey(*key));

        Registry->Visit(TInstant::Zero(), *Visitor);
        UNIT_ASSERT_VALUES_EQUAL(
            "metrics:["
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'20'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'5000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'1000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'100'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'200'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'35000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'2000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'5'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'2'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'1'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'500'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'10'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'>35000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'10000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'50'},"
                    "],"
                    "value:'0',"
                "},"
            "]",
            Data.Str());
        Data.Clear();

        hist.Unregister(key);

        Registry->Visit(TInstant::Zero(), *Visitor);
        UNIT_ASSERT_VALUES_EQUAL("metrics:[]", Data.Str());
        Data.Clear();
    }

    Y_UNIT_TEST_F(ShouldRegisterInDifferentRegistries, TEnv)
    {
        auto first = CreateScopedMetricsRegistry(
            {CreateLabel("first", "registry")},
            Registry);
        auto second = CreateScopedMetricsRegistry(
            {CreateLabel("second", "registry")},
            Registry);

        THistogram<EHistUnit::HU_COUNT> hist;
        hist.Register(first, {CreateLabel("histogram", "Count")});
        hist.Register(second, {CreateLabel("histogram", "Count")});

        Registry->Visit(TInstant::Zero(), *Visitor);
        UNIT_ASSERT_VALUES_EQUAL(
            "metrics:["
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'>35000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'2'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'2000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'10'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'20'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'500'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'1000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'10000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'100'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'5'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'50'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'200'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'1000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'5000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'50'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'20'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'35000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'10000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'1'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'2000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'200'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'10'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'5000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'2'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'500'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'1'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'5'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'>35000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'100'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'35000'},"
                    "],"
                    "value:'0',"
                "},"
            "]",
            Data.Str());
        Data.Clear();

        hist.Record(543);

        Registry->Visit(TInstant::Zero(), *Visitor);
        UNIT_ASSERT_VALUES_EQUAL(
            "metrics:["
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'>35000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'2'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'2000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'10'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'20'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'500'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'1000'},"
                    "],"
                    "value:'1',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'10000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'100'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'5'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'50'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'200'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'1000'},"
                    "],"
                    "value:'1',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'5000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'50'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'20'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'35000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'10000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'1'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'2000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'200'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'10'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'5000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'2'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'500'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'1'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'5'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'first',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'>35000'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'100'},"
                    "],"
                    "value:'0',"
                "},"
                "{"
                    "time:'1970-01-01T00:00:00Z',"
                    "aggregation_type:'sum',"
                    "metric_type:'derivative',"
                    "labels:["
                        "{name:'second',value:'registry'},"
                        "{name:'histogram',value:'Count'},"
                        "{name:'sensor',value:'35000'},"
                    "],"
                    "value:'0',"
                "},"
            "]",
            Data.Str());
        Data.Clear();
    }

    Y_UNIT_TEST_F(ShouldUnregisterOnDestruction, TEnv)
    {
        auto first = CreateScopedMetricsRegistry(
            {CreateLabel("first", "registry")},
            Registry);

        {
            THistogram<EHistUnit::HU_COUNT> hist;
            hist.Register(Registry, {CreateLabel("histogram", "Count")});
            hist.Register(first, {CreateLabel("histogram", "Count")});

            Registry->Visit(TInstant::Zero(), *Visitor);
            UNIT_ASSERT_VALUES_EQUAL(
                "metrics:["
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'first',value:'registry'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'2'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'first',value:'registry'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'2000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'first',value:'registry'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'10'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'2'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'first',value:'registry'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'1000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'first',value:'registry'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'100'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'5000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'50'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'35000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'500'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'first',value:'registry'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'5'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'first',value:'registry'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'50'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'2000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'200'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'first',value:'registry'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'5000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'first',value:'registry'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'20'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'first',value:'registry'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'35000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'first',value:'registry'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'10000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'first',value:'registry'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'1'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'>35000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'first',value:'registry'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'200'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'1000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'100'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'20'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'10'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'first',value:'registry'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'500'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'10000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'1'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'first',value:'registry'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'>35000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'5'},"
                        "],"
                        "value:'0',"
                    "},"
                "]",
                Data.Str());
            Data.Clear();
        }

        Registry->Visit(TInstant::Zero(), *Visitor);
        UNIT_ASSERT_VALUES_EQUAL("metrics:[]", Data.Str());
        Data.Clear();
    }

    Y_UNIT_TEST_F(ShouldAggregateHistogram, TEnv)
    {
        auto service = CreateScopedMetricsRegistry(
            {CreateLabel("service", "service")},
            Registry);

        auto serviceVolume = CreateScopedMetricsRegistry(
            {CreateLabel("service", "service_volume")},
            Registry);
        auto firstVolume = CreateScopedMetricsRegistry(
            {CreateLabel("volume", "first")},
            serviceVolume);
        auto secondVolume = CreateScopedMetricsRegistry(
            {CreateLabel("volume", "second")},
            serviceVolume);

        auto firstAggregator = CreateScopedMetricsRegistry(
            {},
            {service, firstVolume});
        auto secondAggregator = CreateScopedMetricsRegistry(
            {},
            {service, secondVolume});

        {
            THistogram<EHistUnit::HU_COUNT> firstHist;
            firstHist.Register(
                firstAggregator,
                {CreateLabel("histogram", "Count")});

            {
                THistogram<EHistUnit::HU_COUNT> secondHist;
                secondHist.Register(
                    secondAggregator,
                    {CreateLabel("histogram", "Count")});

                Registry->Visit(TInstant::Zero(), *Visitor);
                UNIT_ASSERT_VALUES_EQUAL(
                    "metrics:["
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'200'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'>35000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'2'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'20'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'2000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'500'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'>35000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'5000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'100'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'1'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'5'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'20'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'10000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'20'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'500'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'2000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'500'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'100'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'2000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'35000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'5000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'1000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'10'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'1'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'5'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'10000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'10'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'35000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'>35000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'10'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'5'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'1'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'2'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'1000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'50'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'100'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'2'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'200'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'50'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'5000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'200'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'10000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'35000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'50'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'1000'},"
                            "],"
                            "value:'0',"
                        "},"
                    "]",
                    Data.Str());
                Data.Clear();

                firstHist.Record(543);
                secondHist.Record(754, 2);

                Registry->Visit(TInstant::Zero(), *Visitor);
                UNIT_ASSERT_VALUES_EQUAL(
                    "metrics:["
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'200'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'>35000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'2'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'20'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'2000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'500'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'>35000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'5000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'100'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'1'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'5'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'20'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'10000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'20'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'500'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'2000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'500'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'100'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'2000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'35000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'5000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'1000'},"
                            "],"
                            "value:'2',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'10'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'1'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'5'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'10000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'10'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'35000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'>35000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'10'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'5'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'1'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'2'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'1000'},"
                            "],"
                            "value:'1',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'50'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'100'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'2'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'200'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'second'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'50'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'5000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'200'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service_volume'},"
                                "{name:'volume',value:'first'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'10000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'35000'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'50'},"
                            "],"
                            "value:'0',"
                        "},"
                        "{"
                            "time:'1970-01-01T00:00:00Z',"
                            "aggregation_type:'sum',"
                            "metric_type:'derivative',"
                            "labels:["
                                "{name:'service',value:'service'},"
                                "{name:'histogram',value:'Count'},"
                                "{name:'sensor',value:'1000'},"
                            "],"
                            "value:'3',"
                        "},"
                    "]",
                    Data.Str());
                Data.Clear();
            }

            Registry->Visit(TInstant::Zero(), *Visitor);
            UNIT_ASSERT_VALUES_EQUAL(
                "metrics:["
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'200'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'2'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'20'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'>35000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'1'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service_volume'},"
                            "{name:'volume',value:'first'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'5'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service_volume'},"
                            "{name:'volume',value:'first'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'20'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service_volume'},"
                            "{name:'volume',value:'first'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'500'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service_volume'},"
                            "{name:'volume',value:'first'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'2000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'500'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'100'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'2000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service_volume'},"
                            "{name:'volume',value:'first'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'5000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service_volume'},"
                            "{name:'volume',value:'first'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'10'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'5'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'10000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service_volume'},"
                            "{name:'volume',value:'first'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'35000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service_volume'},"
                            "{name:'volume',value:'first'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'>35000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'10'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service_volume'},"
                            "{name:'volume',value:'first'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'1'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service_volume'},"
                            "{name:'volume',value:'first'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'1000'},"
                        "],"
                        "value:'1',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service_volume'},"
                            "{name:'volume',value:'first'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'50'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service_volume'},"
                            "{name:'volume',value:'first'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'100'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service_volume'},"
                            "{name:'volume',value:'first'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'2'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'5000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service_volume'},"
                            "{name:'volume',value:'first'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'200'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service_volume'},"
                            "{name:'volume',value:'first'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'10000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'35000'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'50'},"
                        "],"
                        "value:'0',"
                    "},"
                    "{"
                        "time:'1970-01-01T00:00:00Z',"
                        "aggregation_type:'sum',"
                        "metric_type:'derivative',"
                        "labels:["
                            "{name:'service',value:'service'},"
                            "{name:'histogram',value:'Count'},"
                            "{name:'sensor',value:'1000'},"
                        "],"
                        "value:'3',"
                    "},"
                "]",
                Data.Str());
            Data.Clear();
        }

        Registry->Visit(TInstant::Zero(), *Visitor);
        UNIT_ASSERT_VALUES_EQUAL("metrics:[]", Data.Str());
        Data.Clear();
    }
}

}   // namespace NCloud::NFileStore::NMetrics
